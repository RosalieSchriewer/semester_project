<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Users</title>
    <link rel="stylesheet" id="themeStylesheet" href="/styles/light-theme.css">

</head>

<body>
    <header>
        <button id="lightModeBtn">Darkmode</button>
        <button id="logoutBtn" style="display: none;" style="background-color: rgb(211, 97, 77),">Logout</button>
        <div id="notificationPopup" class="notification-popup hidden">
            <span id="notificationText"></span>
        </div>
    </header>
    <h1>All Users</h1>

    <div id="userContainer">

    </div>
</body>


<script type="module">
    import { createLightModeButton, showNotification } from "./modules/sharedFunctions.mjs";
    import { handleFetchError } from "./modules/errorHandler.mjs"
    createLightModeButton();
    loadData();

    async function loadData() {
        const token = localStorage.getItem("token");
        const logoutBtn = document.getElementById("logoutBtn")
        if (token) { logoutBtn.style.display = "inline" }
        logoutBtn.addEventListener("click", function () {
            localStorage.clear()
            location.href = "index.html"
        })

        try {
            let response = await fetch("/user/admin/allUsers", {
                method: 'GET',
                headers: { Authorization: token },
            });

            if (response.status != 200) {
                throw new Error("Server error: " + response.status);
            } else {
                let data = await response.json();
                displayUserData(data);
            }
        } catch (error) {
            console.error("The error is: " + error);
            handleFetchError(error)
        }
    }

    function displayUserData(data) {
        const userContainer = document.getElementById("userContainer");

        data.forEach(user => {
            const userCard = createUserCard(user);
            userContainer.appendChild(userCard);
        });
    }

    function createUserCard(user) {
        const userCard = document.createElement("div");
        userCard.className = "user-card";
        userCard.dataset.userid = user.id;

        const lastLogin = formatDateTime(user.lastLogin);

        userCard.innerHTML = `
            <label for="userName">Name:</label>
            <input type="text" id="userName-${user.id}" value="${user.name}" disabled />

            <label for="userEmail">Email:</label>
            <input type="email" id="userEmail-${user.id}" value="${user.email}" disabled />

            <label for="userRole">Role:</label>
            <select id="userRole-${user.id}" disabled>
                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>

            <label for="userLightmode">Lightmode:</label>
            <input type="text" id="userLightmode-${user.id}" value="${user.lightmode}" disabled />

            <label for="userLastLogin">Last login:</label>
            <input type="text" id="userLastLogin-${user.id}" value="${lastLogin}" disabled />

            <button class="editButton" data-userid="${user.id}">Edit</button>
        `;

        const editButton = userCard.querySelector('.editButton');
        editButton.addEventListener('click', () => editUser(user.id, userCard));

        return userCard;
    }

    function formatDateTime(dateTimeString) {
        const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
        const dateTime = new Date(dateTimeString);
        return dateTime.toLocaleDateString('en-GB', options).replace(/(\d+)\/(\d+)\/(\d+),? (\d+):(\d+)/, '$1.$2.$3 $4:$5');
    }

    function editUser(userId, userCard) {
        const userRoleInput = userCard.querySelector(`#userRole-${userId}`);

        if (userCard.dataset.editable === "true") {
            userRoleInput.disabled = true;
            const saveButton = userCard.querySelector('.saveButton');
            if (saveButton != null) {
                saveButton.remove();
            }
            userCard.dataset.editable = "false";
        } else {
            userRoleInput.disabled = false;
            const saveButton = createSaveButton(userId, userRoleInput, userCard);
            userCard.dataset.editable = "true";
            userCard.appendChild(saveButton);
        }
    }

    function createSaveButton(userId, userRoleInput, userCard) {
        const saveButton = document.createElement('button');
        saveButton.innerText = 'Save Changes';
        saveButton.className = 'saveButton';

        saveButton.addEventListener('click', async () => {
            const userRole = userRoleInput.value;
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`/user/admin/updateUserRole/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: userRole })
                });

                if (response.status === 200) {
                    showNotification('User updated successfully');
                    userRoleInput.disabled = true;
                    saveButton.remove();
                    userCard.dataset.editable = "false";
                } else {
                    const data = await response.json();
                    throw new Error(data.error || 'Server error');
                }
            } catch (error) {
                console.error('Error updating user:', error);
                showNotification('Error updating user');
                handleFetchError(error);
            }
        });

        return saveButton;
    }
</script>

</html>