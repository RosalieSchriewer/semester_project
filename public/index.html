<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>

  <link rel="stylesheet" id="themeStylesheet" href="/styles/light-theme.css">
</head>

<body>
  <div id="notificationPopup" class="notification-popup hidden">
    <span id="notificationText"></span>
  </div>
  <div>
  <button id="lightModeBtn">Darkmode</button>
  <button id="createAccBtn">Create account</button>
  <button id="loginBtn" class="greenButton">Login</button>
  <button id="profileBtn" style="display: none;">My profile</button>
  <button id="logoutBtn" style="display: none;" style="background-color: rgb(211, 97, 77),">Logout</button>
  <!-- <h1>Create you avatar</h1> -->
</div>
<div><button id="checkBtn" class="globalBtn">&#10004</button>
  <button id="shareBtn" class="globalBtn">Share this avatar</button></div>

  <div id="choiceMenu">
    
    <img class="thumbnail" src="./avatarstudio/Media/head.png">
    <img class="thumbnail" src="./avatarstudio/Media/head.png">
    <img class="thumbnail" src="./avatarstudio/Media/head.png">
    <img class="thumbnail" src="./avatarstudio/Media/head.png">
    <img class="thumbnail" src="./avatarstudio/Media/head.png">
    <img class="thumbnail" src="./avatarstudio/Media/eyebrowRender.jpg" id="loadEyebrows2Button">
    <img class="thumbnail" src="./avatarstudio/Media/eyebrow-1Render.jpg" id="loadEyebrowsButton">
  </div>
</body>

<script type="module">


  import { loadScene } from "./avatarstudio/Script/main.js";
  import { avatarData } from "./avatarstudio/Script/scene.js";
  import { createLightModeButton, showNotification } from "./modules/sharedFunctions.js";


  loadScene()



  let token = localStorage.getItem("token")

  const createAccBtn = document.getElementById("createAccBtn")
  if (token) { createAccBtn.style.display = "none" }
  createAccBtn.addEventListener("click", function () {
    location.href = "createAccount.html"
  })

  const loginBtn = document.getElementById("loginBtn")
  if (token) { loginBtn.style.display = "none" }
  loginBtn.addEventListener("click", function () {
    location.href = "login.html"
  })

  const profileBtn = document.getElementById("profileBtn")
  if (token) { profileBtn.style.display = "inline" }
  profileBtn.addEventListener("click", function () {
    location.href = "editUser.html"
  })

  const logoutBtn = document.getElementById("logoutBtn")
  if (token) { logoutBtn.style.display = "inline" }
  logoutBtn.addEventListener("click", function () {
    localStorage.clear()
    location.href = "index.html"
  })

 

     createLightModeButton();
   
 


  const checkBtn = document.getElementById("checkBtn")
  const shareBtn = document.getElementById("shareBtn")

  if (!token) {
    checkBtn.style.display = "none"
    shareBtn.style.display = "none"
  }


  console.log(avatarData)
  checkBtn.addEventListener("click", async function (event) {

    try {
      let response = await fetch("/user/saveAvatar", {
        method: "PUT",
        headers: {
          Authorization: token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(avatarData),
      });
      if (response.status == 200) {
        let data = await response.json();
        localStorage.setItem("userHairColor", avatarData.hairColor);
        localStorage.setItem("userSkinColor", avatarData.skinColor);
        localStorage.setItem("userEyeColor", avatarData.eyeColor);
        localStorage.setItem("userEyebrowType", avatarData.eyebrowType);
        showNotification("Saved your Avatar!")

      } else if (response.status === 401) {
        localStorage.clear()
        alert("Login expired, please log in again")
        location.href = "login.html"

      } else {
        throw new Error("Server error: " + response.status);
      }
    } catch (error) {

      console.error("The error is: " + error);
      
    }

  });
  

  shareBtn.addEventListener("click", async function (event) {
  //  console.log(JSON.parse(avatarData))
   

    try {
      let response = await fetch("user/generateShareableLink", {
        method: "POST",
        headers: {
          Authorization: token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(avatarData),
      });

      if (response.status == 200) {
        let data = await response.json();
        const shareableLink = data.shareableLink;
        console.log("this", shareableLink)
        showNotification("Shareable link generated: " + shareableLink);
        console.log(shareableLink)
      } else if (response.status === 401) {
        localStorage.clear();
        alert("Login expired, please log in again");
        location.href = "login.html";
      }else {
        throw new Error("Server error: " + response.status);
      }
    } catch (error) {
      console.error("The error is: " + error);
    }
  
  });

</script>

</html>