<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>

  <link rel="stylesheet" id="themeStylesheet" href="/styles/light-theme.css">
</head>

<body>
  <div id="notificationPopup" class="notification-popup hidden">
    <span id="notificationText"></span>
  </div>
  <header>
    <div>
      <div id="languageSwitcher">
        <button id="languageSwitchButton" data-translate="switchLanguage">Switch Language</button>
        <ul id="languageDropdown" style="display: none;">
          <li><a href="#" data-language="en" data-translate="english">English</a></li>
          <li><a href="#" data-language="no" data-translate="norwegian">Norwegian</a></li>
          <li><a href="#" data-language="de" data-translate="german">German</a></li>
        </ul>
      </div>

      <button id="lightModeBtn" data-translate="darkmode">Darkmode</button>
      <button id="createAccBtn" data-translate="createAccount">Create account</button>
      <button id="loginBtn" class="greenButton" data-translate="login">Login</button>
      <button id="profileBtn" style="display: none;" data-translate="myProfile">My profile</button>
      <button id="logoutBtn" style="display: none;" style="background-color: rgb(211, 97, 77),"
        data-translate="logout">Logout</button>
  </header>
  </div>
  <div><button id="checkBtn" class="globalBtn">&#10004</button>
    <button id="shareBtn" class="globalBtn" data-translate="shareAvatar">Share this avatar</button>
  </div>

  <div id="choiceMenu">

    <img class="thumbnail" alt="image of a head" src="./avatarStudio/media/head.png">
    <img class="thumbnail" alt="image of a head" src="./avatarStudio/media/head.png">
    <img class="thumbnail" alt="image of a head"src="./avatarStudio/media/head.png">
    <img class="thumbnail" alt="image of a head"src="./avatarStudio/media/head.png">
    <img class="thumbnail" alt="image of a head"src="./avatarStudio/media/head.png">
    <img class="thumbnail" alt="image of a head"src="./avatarStudio/media/eyebrowRender.jpg" id="loadEyebrows2Button">
    <img class="thumbnail" alt="image of a head"src="./avatarStudio/media/eyebrow-1Render.jpg" id="loadEyebrowsButton">
  </div>
</body>

<script type="module">


  import { loadScene } from "./avatarStudio/script/main.mjs";
  import { avatarData } from "./avatarStudio/script/scene.mjs";
  import { createLightModeButton, showNotification, changeLanguage, showNotificationWithLink } from "./modules/sharedFunctions.mjs";
  import { handleFetchError,HTTPCode } from "./modules/errorHandler.mjs"


  loadScene()
  changeLanguage()


  let token = localStorage.getItem("token")

  const createAccBtn = document.getElementById("createAccBtn")
  if (token) { createAccBtn.style.display = "none" }
  createAccBtn.addEventListener("click", function () {
    location.href = "createAccount.html"
  })

  const loginBtn = document.getElementById("loginBtn")
  if (token) { loginBtn.style.display = "none" }
  loginBtn.addEventListener("click", function () {
    location.href = "login.html"
  })

  const profileBtn = document.getElementById("profileBtn")
  if (token) { profileBtn.style.display = "inline" }
  profileBtn.addEventListener("click", function () {
    location.href = "editUser.html"
  })

  const logoutBtn = document.getElementById("logoutBtn")
  if (token) { logoutBtn.style.display = "inline" }
  logoutBtn.addEventListener("click", function () {
    localStorage.clear()
    location.href = "index.html"
  })



  createLightModeButton();




  const checkBtn = document.getElementById("checkBtn")
  const shareBtn = document.getElementById("shareBtn")

  if (!token) {
    checkBtn.style.display = "none"
    shareBtn.style.display = "none"
  }



  checkBtn.addEventListener("click", async function (event) {

    try {
      let response = await fetch("/user/saveAvatar", {
        method: "PUT",
        headers: {
          Authorization: token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(avatarData),
      });
      if (response.status == HTTPCode.Ok) {
        let data = await response.json();
        localStorage.setItem("userHairColor", avatarData.hairColor);
        localStorage.setItem("userSkinColor", avatarData.skinColor);
        localStorage.setItem("userEyeColor", avatarData.eyeColor);
        localStorage.setItem("userEyebrowType", avatarData.eyebrowType);
        showNotification("Saved your Avatar!")

      } else if (response.status === HTTPCode.Unauthorized) {
        localStorage.clear()
        alert("Login expired, please log in again")
        location.href = "login.html"

      } else {
        throw new Error("Server error: " + response.status);
      }
    } catch (error) {

      console.error("The error is: " + error);
      handleFetchError(error)

    }

  });


  shareBtn.addEventListener("click", async function (event) {



    try {
      let response = await fetch("user/generateShareableLink", {
        method: "POST",
        headers: {
          Authorization: token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(avatarData),
      });

      if (response.status == HTTPCode.Ok) {
        let data = await response.json();
        const shareableLink = data.shareableLink;

        showNotificationWithLink(shareableLink);

      } else if (response.status === HTTPCode.Unauthorized) {
        localStorage.clear();
        alert("Login expired, please log in again");
        location.href = "login.html";
      } else {
        throw new Error("Server error: " + response.status);
      }
    } catch (error) {
      console.error("The error is: " + error);
      handleFetchError(error)
    }

  });

</script>

</html>